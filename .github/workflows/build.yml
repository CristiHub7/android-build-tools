name: build

on: [push, pull_request]

jobs:
  linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: arm64
            triplet: aarch64-linux-gnu

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: true

    # Fix: GitHub runner apt sources can 404 for arm64 on security.ubuntu.com
    - name: Fix apt sources for multiarch
      run: |
        sudo sed -i 's|http://security.ubuntu.com/ubuntu|http://archive.ubuntu.com/ubuntu|g' /etc/apt/sources.list || true
        sudo sed -i 's|https://security.ubuntu.com/ubuntu|http://archive.ubuntu.com/ubuntu|g' /etc/apt/sources.list || true
        sudo find /etc/apt/sources.list.d -type f -maxdepth 1 -print -exec sudo sed -i \
          's|http://security.ubuntu.com/ubuntu|http://archive.ubuntu.com/ubuntu|g; s|https://security.ubuntu.com/ubuntu|http://archive.ubuntu.com/ubuntu|g' {} \; || true

    - name: Install cross toolchain + arm64 deps
      run: |
        sudo dpkg --add-architecture arm64
        sudo apt-get update

        # Native build tools (amd64)
        sudo apt-get install -y --no-install-recommends \
          git cmake ninja-build pkg-config bison flex

        # Cross compiler + sysroot
        sudo apt-get install -y --no-install-recommends \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
          libc6-dev-arm64-cross

        # Target (arm64) headers/libs
        sudo apt-get install -y --no-install-recommends \
          libexpat1-dev:arm64 \
          libfmt-dev:arm64 \
          libpng-dev:arm64 \
          libgtest-dev:arm64 \
          libprotobuf-dev:arm64 protobuf-compiler \
          zlib1g-dev:arm64

        # For verification (run arm64 binaries)
        sudo apt-get install -y --no-install-recommends qemu-user

    - name: Prepare
      run: |
        git config --global user.email "you@example.com"
        git config --global user.name "Your Name"

    - name: Write CMake toolchain file (arm64)
      run: |
        cat > toolchain-aarch64.cmake <<'EOF'
        set(CMAKE_SYSTEM_NAME Linux)
        set(CMAKE_SYSTEM_PROCESSOR aarch64)

        set(CMAKE_C_COMPILER   aarch64-linux-gnu-gcc)
        set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)

        set(CMAKE_SYSROOT /usr/aarch64-linux-gnu)

        set(CMAKE_FIND_ROOT_PATH
          /usr/aarch64-linux-gnu
          /usr/lib/aarch64-linux-gnu
          /usr/include/aarch64-linux-gnu
        )

        set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
        set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)
        EOF

    - name: Build (cross-compile arm64)
      env:
        PKG_CONFIG_SYSROOT_DIR: /
        PKG_CONFIG_LIBDIR: /usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/toolchain-aarch64.cmake
        cmake --build build

    - name: Check (run via qemu-aarch64)
      run: |
        qemu-aarch64 -L /usr/aarch64-linux-gnu ./build/vendor/aapt version
        qemu-aarch64 -L /usr/aarch64-linux-gnu ./build/vendor/aapt2 version

    - name: Upload artifact v4
      uses: actions/upload-artifact@v4
      with:
        name: aapt-linux-arm64
        path: |
          build/vendor/aapt
          build/vendor/aapt2
        if-no-files-found: error


  mingw:
    runs-on: windows-latest
    strategy:
      matrix:
        msystem: [clang64, ucrt64]
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      uses: msys2/setup-msys2@v2
      with:
        msystem: ${{ matrix.msystem }}
        install: base-devel git
        pacboy: cc cmake expat fmt gtest libpng ninja pkgconf protobuf

    - name: Prepare
      run: |
        git submodule update --init --depth 1
        git config --global user.email "you@example.com"
        git config --global user.name "Your Name"
        cd vendor/core
        git config core.symlinks true
        MSYS='winsymlinks:nativestrict' git restore --source=HEAD :/ || true

    - name: Build
      run: |
        cmake -B build -G Ninja
        cmake --build build

    - name: Check
      run: |
        ./build/vendor/aapt version
        ./build/vendor/aapt2 version

    - name: Upload artifact v4
      uses: actions/upload-artifact@v4
      with:
        name: aapt-windows-${{ matrix.msystem }}
        path: |
          build/vendor/aapt.exe
          build/vendor/aapt2.exe
        if-no-files-found: error
